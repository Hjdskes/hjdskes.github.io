<!DOCTYPE html>
<head>
  <meta charset="utf-8"/>
  <meta name="author" content="Jente Hidskes"/>
  <meta name="description" content="GSoC blog series on rewriting Piper"/>
  <meta name="generator" content="Hugo 0.46" />
  <meta name="referrer" content="no-referrer"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <meta property="og:description" content="GSoC blog series on rewriting Piper"/>
  <meta property="og:locale" content="en-us"/>
  <meta property="og:site_name" content="Jente Hidskes&#39; website"/>
  <meta property="og:title" content="GSoC part 12: the finishing touches"/>
  <meta property="og:type" content="article"/>
  <meta property="og:url" content="https://hjdskes.nl/blog/gsoc-part-12/"/>
  <meta property="og:image" content="https://hjdskes.nl/img/avatar.png"/>

  <title> Jente Hidskes&#39; website - GSoC part 12: the finishing touches </title>

  <link rel="canonical" href="https://hjdskes.nl/blog/gsoc-part-12/"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito|Quicksand|Roboto+Mono"/>
  <link rel="stylesheet" type="text/css" href="/css/stylesheet.css"/>
  <link rel="stylesheet" type="text/css" href="/css/syntax.css"/>
  <link rel="stylesheet" type="text/css" href="/css/zoom.css"/>
  
  <link rel="shortcut icon" href="https://hjdskes.nl/img/favicon.ico"/>

  <script type="text/javascript" src="/js/zoom-vanilla.js"></script>
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
	images = document.querySelectorAll("img[data-action=\"zoom\"]");
	images.forEach(function(image) {
	    image.style.display = "block";
	})
    }, false);
  </script>
</head>

<body>
  <div class="banner">
    <a href="https://hjdskes.nl/"><img class="logo" src="https://hjdskes.nl/img/avatar.png" alt="logo" /></a>
    <div>
      <a id="name" href="https://hjdskes.nl/"><h1>Jente Hidskes&#39; website</h1></a>
      <nav>
        
        <a href="/blog/">Blog</a>
        
        
          
            
          
        
          
            
              <a href="https://hjdskes.nl/contributions">Contributions</a>
            
          
        
          
            
              <a href="https://hjdskes.nl/projects">Projects</a>
            
          
        
        
          
            <a href="https://hjdskes.nl/about/">About me</a>
          
        
          
        
      </nav>
    </div>
  </div>


<div class="page-heading">
  <h1>GSoC part 12: the finishing touches</h1>
</div>

<div class="meta">Aug 11, 2017<div class="middot">5 minute read</div>
  <div class="tags">
    <ul>
      
        <li class="middot"><a href="/tags/piper">Piper</a></li>
      
        <li class="middot"><a href="/tags/fdo">fdo</a></li>
      
        <li class="middot"><a href="/tags/button">button</a></li>
      
        <li class="middot"><a href="/tags/rewrite">rewrite</a></li>
      
    </ul>
  </div>
</div>

<div class="content">
  

<p><img src="/img/blog/gsoc-part-1/GSoC-logo-horizontal.svg" alt="GSoC logo horizontal" /></p>

<p>Last week I shared the news that all large features had been implemented; all
that was left were issues raised by GNOME contributors when my mentor demoed my
progress over GUADEC. This week I&rsquo;ve just been chugging away on those issues;
let me show you.</p>

<h3 id="obvious-save-button-is-not-obvious">Obvious save button is.. not obvious?</h3>

<p><a href="http://www.hadess.net/">Hadess</a>
<a href="https://github.com/libratbag/piper/issues/69">noted</a> that the save button
wasn&rsquo;t obvious when my mentor demoed Piper to him; I already mentioned this last
week: the icon is a <q>save to disk</q> icon and it&rsquo;s not obvious at first
glance that you have to press it to write the changes you made to the device. I
discussed that we want to go for a time-based commit, where the changes are
committed to the device automatically after certain events (e.g. switching stack
pages) or after a certain interval of inactivity. Since that will require more
work and is thus something for a later version, I went with the other options to
at least solve the problem for now:</p>

<video controls>
  <source src="/img/blog/gsoc-part-12/commit.webm" type="video/webm">
Your browser does not support the video tag.
</video>

<p>As you can see, the icon has been replaced with text and the button is now
insensitive when there are no changes to be committed. When there are, the
button is sensitive and the <code>suggested-action</code> CSS class is applied to the
button, in order to draw the user&rsquo;s attention that something needs to be
committed. You can view the pull request
<a href="https://github.com/libratbag/piper/pull/101">here</a>.</p>

<h3 id="shutdown-confirmation">Shutdown confirmation</h3>

<p>Related to the above (and unsurprisingly also suggested by hadess) is asking for
confirmation when the user attempts to close Piper with unsaved changes:</p>

<video controls>
  <source src="/img/blog/gsoc-part-12/shutdown.webm" type="video/webm">
Your browser does not support the video tag.
</video>

<p>This shows the versatility of the perspective abstraction; all it takes is
adding a single new property to each perspective:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">can_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Whether this perspective can safely shutdown.&#34;&#34;&#34;</span>
    <span class="k">for</span> <span class="n">profile</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="o">.</span><span class="n">profiles</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">profile</span><span class="o">.</span><span class="n">dirty</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span></code></pre></div>
<p>This property signals whether a perspective can safely shutdown. On a <a href="https://lazka.github.io/pgi-docs/Gtk-3.0/classes/Widget.html#Gtk.Widget.signals.delete_event">delete
event</a>,
the window checks all its perspectives&rsquo; properties and if one perspective
signals that it cannot safely shutdown, it presents the dialog:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">do_delete_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">perspective</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_perspectives</span><span class="o">.</span><span class="n">get_children</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">perspective</span><span class="o">.</span><span class="n">can_shutdown</span><span class="p">:</span>
            <span class="n">dialog</span> <span class="o">=</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">MessageDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">DialogFlags</span><span class="o">.</span><span class="n">MODAL</span><span class="p">,</span>
                                       <span class="n">Gtk</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">QUESTION</span><span class="p">,</span>
                                       <span class="n">Gtk</span><span class="o">.</span><span class="n">ButtonsType</span><span class="o">.</span><span class="n">YES_NO</span><span class="p">,</span>
                                       <span class="n">_</span><span class="p">(</span><span class="s2">&#34;There are unapplied changes. Are you sure you want to quit?&#34;</span><span class="p">))</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="n">dialog</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">ResponseType</span><span class="o">.</span><span class="n">NO</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">==</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">ResponseType</span><span class="o">.</span><span class="n">DELETE_EVENT</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Gdk</span><span class="o">.</span><span class="n">EVENT_STOP</span>
    <span class="k">return</span> <span class="n">Gdk</span><span class="o">.</span><span class="n">EVENT_PROPAGATE</span></code></pre></div>
<h3 id="device-dis-connects">Device (dis)connects</h3>

<p>This was the last unimplemented feature that my mentor and I agreed Piper had to
have when we came up with the GSoC proposal. I saved it for last because it&rsquo;s
quite a niche case to own (let alone use simultaneously) two devices, but it had
to be done at some point. The welcome perspective was already implemented <a href="/blog/gsoc-part-11#perspectives">last
week</a>; it was simply a matter of <a href="https://github.com/libratbag/piper/pull/97/commits/0b27bf912f66f4c92f18cb70b1f2369aa35da648">adding the
right signals to the ratbagd
bindings</a>,
<a href="https://github.com/libratbag/piper/pull/97/commits/84a50882d11526a29a27c0915fd27bb23542cc2f">fixing said
bindings</a>,
<a href="https://github.com/libratbag/piper/pull/97/commits/d93a3ba570cc8fc6d7c4dd1f6bb575524545b804">adding methods to add and remove devices from the welcome
perspective</a>
and <a href="https://github.com/libratbag/piper/pull/97/commits/062f881951b6812242a7e2a34fae417f73fe30b0">connecting the
dots</a>.
For the last step, it was a bit of puzzling to figure out all the scenarios but
I believe I&rsquo;ve got them all:</p>

<p>When a device is added and there:</p>

<ul>
<li>is no device connected currently → immediately configure the connected device</li>
<li>are devices currently connected and we are in the welcome perspective → add
the new device to the list</li>
<li>is (are) device(s) currently connected and we are the in mouse perspective →
make the back button visible (see below)</li>
</ul>

<p>When a device is removed and:</p>

<ul>
<li>the removed device is the one currently being edited → error perspective</li>
<li>there is (are) device(s) currently connected and we are in the welcome
perspective → remove it from the list. If it was the last device, display the
error perspective</li>
<li>there are devices currently connected and we are configuring another device in
the mouse perspective → hide the back button if required</li>
</ul>

<p>Of course you can mix and match these, for example if you are configuring a
device, disconnect it and then connect it again you&rsquo;ll jump straight back into
editing it.</p>

<h3 id="back-button">Back button</h3>

<p>When multiple devices are connected, you might want to configure more than
one as well. It is inconvenient to have to close and open Piper again, so for
this scenario I have given perspectives the option to declare whether they want
a back button to be shown, which will take the user back to the welcome
perspective to switch between devices:</p>

<video controls>
  <source src="/img/blog/gsoc-part-12/back.webm" type="video/webm">
Your browser does not support the video tag.
</video>

<p>Again we add another property to the perspectives interface:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@GObject.Property</span>
<span class="k">def</span> <span class="nf">can_go_back</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Whether this perspective wants a back button to be displayed in case
</span><span class="s2">    there is more than one connected device.&#34;&#34;&#34;</span>
    <span class="k">return</span> <span class="bp">True</span></code></pre></div>
<p>This allows the window class to insert a back button into the perspectives&rsquo;
titlebars and prevents all perspectives of having to add it themselves:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">_add_perspective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perspective</span><span class="p">,</span> <span class="n">ratbag</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stack_perspectives</span><span class="o">.</span><span class="n">add_named</span><span class="p">(</span><span class="n">perspective</span><span class="p">,</span> <span class="n">perspective</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stack_titlebar</span><span class="o">.</span><span class="n">add_named</span><span class="p">(</span><span class="n">perspective</span><span class="o">.</span><span class="n">titlebar</span><span class="p">,</span> <span class="n">perspective</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">perspective</span><span class="o">.</span><span class="n">can_go_back</span><span class="p">:</span>
        <span class="n">button_back</span> <span class="o">=</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">Button</span><span class="o">.</span><span class="n">new_from_icon_name</span><span class="p">(</span><span class="s2">&#34;go-previous-symbolic&#34;</span><span class="p">,</span>
                                                    <span class="n">Gtk</span><span class="o">.</span><span class="n">IconSize</span><span class="o">.</span><span class="n">BUTTON</span><span class="p">)</span>
        <span class="n">button_back</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ratbag</span><span class="o">.</span><span class="n">devices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">button_back</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&#34;clicked&#34;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">button</span><span class="p">,</span> <span class="n">ratbag</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_present_welcome_perspective</span><span class="p">(</span><span class="n">ratbag</span><span class="o">.</span><span class="n">devices</span><span class="p">),</span>
                            <span class="n">ratbag</span><span class="p">)</span>
        <span class="n">ratbag</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&#34;notify::devices&#34;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">ratbag</span><span class="p">,</span> <span class="n">pspec</span><span class="p">:</span>
                       <span class="n">button_back</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ratbag</span><span class="o">.</span><span class="n">devices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">perspective</span><span class="o">.</span><span class="n">titlebar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">button_back</span><span class="p">)</span>
        <span class="c1"># Place the button first in the titlebar.</span>
        <span class="n">perspective</span><span class="o">.</span><span class="n">titlebar</span><span class="o">.</span><span class="n">child_set_property</span><span class="p">(</span><span class="n">button_back</span><span class="p">,</span> <span class="s2">&#34;position&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></code></pre></div>
<p>That&rsquo;s a small amount of code for another large dose o&rsquo; polish!</p>

<h3 id="other-smaller-changes">Other smaller changes</h3>

<p>In making ratbagd use enums everywhere as opposed to strings for some
properties, the <code>ResolutionsPage</code> was left behind and couldn&rsquo;t display which
buttons were assigned special mappings that relate to resolutions. I
<a href="https://github.com/libratbag/piper/pull/95">fixed</a> that this week; you can see
it work again in the videos above.</p>

<p>Last week I <a href="/blog/gsoc-part-11#GUADEC-issues">dropped indices from the UI</a>, but
this left the resolution rows looking quite empty. The solution is to simply
make them <a href="https://github.com/libratbag/piper/pull/94">less wide</a>, although this
might change when we cannot fix the range of the resolution scale
logarithmically or by simply limitting it, as discussed in the linked pull
request and <a href="https://github.com/libratbag/piper/issues/68">this issue</a>.</p>

<p>The last noteworthy change of this week is that the key capture for macros now
also supports <a href="https://github.com/libratbag/piper/pull/106">key releases</a>, but
this isn&rsquo;t merged yet. We decided to
<a href="https://github.com/libratbag/piper/issues/62">drop</a> button capture for now, as
this isn&rsquo;t (yet?) properly supported by libratbag.</p>

<p>That&rsquo;s it for this week! The coming week will be more of the same: adding spit
&lsquo;n polish where it is needed the most.</p>

<p>This blog post is part of a <a href="/series/google-summer-of-code/">series</a>. You can read the next part about saving the
planet <a href="/blog/gsoc-part-13">here</a> or the previous part about the welcome screen
<a href="/blog/gsoc-part-11">here</a>.</p>

</div>

<div id="postamble">
  <footer>
    <nav class="social-icons">
       
        <a href="mailto:hjdskes@gmail.com" title="Send a mail to hjdskes@gmail.com">
          <svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
            <polyline points="22,6 12,13 2,6"/>
          </svg>
        </a>
      

       
        <a href="https://github.com/Hjdskes" title="Hjdskes on GitHub">
          <svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true">
            <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
	  </svg>
        </a>
      

       
        <a href="https://hjdskes.nl/index.xml" title="RSS feed">
          <svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true">
            <path d="M4 11a9 9 0 0 1 9 9"/>
	    <path d="M4 4a16 16 0 0 1 16 16"/>
	    <circle cx="5" cy="19" r="1"/>
	  </svg>
        </a>
      
    </nav>

    <div id="license-note">
      <a href="/license">Copyright © 2016-2018 Jente Hidskes</a>
    </div>
  </footer>
</div>

</body>
</html>

