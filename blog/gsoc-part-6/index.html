<!DOCTYPE html>
<head>
  <meta charset="utf-8"/>
  <meta name="author" content="Jente Hidskes"/>
  <meta name="description" content="GSoC blog series on rewriting Piper"/>
  <meta name="generator" content="Hugo 0.51" />
  <meta name="referrer" content="no-referrer"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <meta property="og:description" content="GSoC blog series on rewriting Piper"/>
  <meta property="og:locale" content="en-us"/>
  <meta property="og:site_name" content="Jente Hidskes&#39; website"/>
  <meta property="og:title" content="GSoC part 6: progress!"/>
  <meta property="og:type" content="article"/>
  <meta property="og:url" content="https://hjdskes.nl/blog/gsoc-part-6/"/>
  <meta property="og:image" content="https://hjdskes.nl/img/avatar.svg"/>

  <meta name="twitter:card" content="summary"/>
  
  <meta name="twitter:site" content="Hjdskes"/>
  
  <meta name="twitter:image:alt" content="Logo"/>

  <title> Jente Hidskes&#39; website - GSoC part 6: progress! </title>

  <link rel="canonical" href="https://hjdskes.nl/blog/gsoc-part-6/"/>
  
  <link rel="shortcut icon" href="https://hjdskes.nl/img/favicon.ico"/>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito|Quicksand|Roboto+Mono"/>
  <link rel="stylesheet" type="text/css" href="/css/stylesheet.css"/>
</head>

<body>
  <div class="banner">
    <a href="https://hjdskes.nl/"><img class="logo" src="https://hjdskes.nl/img/avatar.svg" alt="logo" /></a>
    <div>
      <a id="name" href="https://hjdskes.nl/"><h1>Jente Hidskes&#39; website</h1></a>
      <nav>
        
        <a href="/blog/">Blog</a>
        
        
          
            
          
        
          
            
              <a href="https://hjdskes.nl/contributions">Contributions</a>
            
          
        
          
            
              <a href="https://hjdskes.nl/projects">Projects</a>
            
          
        
        
          
            <a href="https://hjdskes.nl/about/">About me</a>
          
        
          
        
      </nav>
    </div>
  </div>


<div class="page-heading">
  <h1>GSoC part 6: progress!</h1>
</div>

<div class="meta">Jun 30, 2017<div class="middot">9 minute read</div>
  <div class="tags">
    <ul>
      
        <li class="middot"><a href="/tags/piper">Piper</a></li>
      
        <li class="middot"><a href="/tags/fdo">fdo</a></li>
      
        <li class="middot"><a href="/tags/mousemap">MouseMap</a></li>
      
        <li class="middot"><a href="/tags/xpath">XPath</a></li>
      
        <li class="middot"><a href="/tags/xml">XML</a></li>
      
    </ul>
  </div>
</div>

<div class="content">
  

<p><img src="/img/blog/gsoc-part-1/GSoC-logo-horizontal.svg" alt="GSoC logo horizontal" /></p>

<p>This week Piper saw some progress again! Today I opened the <a href="https://github.com/libratbag/piper/pull/20">pull request</a>
for the MouseMap that I&rsquo;ve been working on for the past two and a half weeks
now. I&rsquo;ll discuss the changes made since the last blog <a href="/blog/gsoc-part-6#mousemap">later</a>; first,
I want to highlight the other work I did the past week.</p>

<p>A major milestone this week is the <a href="https://github.com/libratbag/libratbag/pull/184">merging</a> of ratbagd and libratbag.
While Piper shouldn&rsquo;t notice any of this (it talks to ratbagd over DBus), it&rsquo;s
still a highlight I want to mention. I also passed for the first evaluation, so
I can keep working &#9786;.</p>

<h3 id="ratbagd-led-api">Ratbagd LED API</h3>

<p>libratbag has supported configuring LEDs for a while now, but this hadn&rsquo;t been
implemented in ratbagd yet. Piper will need the implementation in ratbagd in
order to expose the settings to the user, so last week I sat down to add the
missing code in ratbagd. You can see the resulting PR <a href="https://github.com/libratbag/ratbagd/pull/35">here</a>.</p>

<p>Since Piper now manages its own ratbagd <q>bindings</q> (they really are just
DBus wrappers), I added support for the newly exposed DBus interface straight
away. This was merged <a href="https://github.com/libratbag/piper/pull/17">today</a>.</p>

<h3 id="minimum-and-maximum-resolution-in-piper-s-ratbagd-bindings">Minimum and maximum resolution in Piper&rsquo;s ratbagd bindings</h3>

<p>Last week, my mentor exposed a device&rsquo;s minimum and maximum resolution through
libratbag and ratbagd. Today I quickly <a href="https://github.com/libratbag/piper/pull/21">implemented</a> this in Piper&rsquo;s
ratbagd bindings, as well.</p>

<h3 id="adhering-to-pep8-in-piper">Adhering to PEP8 in Piper</h3>

<p>Adhering to a certain style is good. It makes your code consistent, which helps
when reading it. Since code is read more often than it is written, this is a
good thing.</p>

<p>The most used convention in Python is <a href="https://www.python.org/dev/peps/pep-0008/#introduction">PEP8</a>. From this week forward,
Piper <a href="https://github.com/libratbag/piper/pull/18">adheres</a> to PEP8. We&rsquo;re using <a href="http://flake8.pycqa.org/en/latest/">flake8</a> to check this.
Personally I use flake8&rsquo;s <a href="http://flake8.pycqa.org/en/latest/user/using-hooks.html">Git hook</a>, but we now also have a
<a href="https://github.com/libratbag/piper/pull/22">CircleCI build</a> running for every PR to run flake8. In the future,
this will probably also be used to run unit tests.</p>

<h3 id="adding-the-finishing-touches-to-the-mousemap">Adding the finishing touches to the MouseMap</h3>

<p>The most obvious change is that the MouseMap now also works with left-aligned
children:</p>

<p><img src="/img/blog/gsoc-part-6/mousemap-left-aligned.png" alt="Left-aligned children" /></p>

<p>Detecting where a widget should be aligned is rather straightforward, but it
took a while to get to where we are now. At first, the leaders ended with a
1&#215;1 pixel whose x-coordinate I queried. Coordinates with a value of zero
would be left aligned, and others right aligned. My mentor rightfully thought
that this wasn&rsquo;t a nice approach, because there is no meaning to this random
value. He suggested I talk with bentiss (Benjamin), who also had to lay out
buttons around an SVG for GNOME&rsquo;s settings daemon. Benjamin suggested that we
add back labels into the SVG, who would be right-aligned on the left side and
left-aligned on the right side (savvy? &#128521;). This worked, but 1) it
required that the drawn widgets are large enough to completely cover the labels
and 2) it messed up the calculation of the width, as there was no way to
determine how much the widget would overlap on the SVG. The solution here was to
remove the labels from the XML tree before opening a librsvg handle, but now
there were no labels left whose coordinates to check&hellip; Of course, we could
parse those ahead of time and remember all the coordinates, but we don&rsquo;t have
the element identifiers until the widgets are added to the container and by this
time the handle is already instantiated.</p>

<p>So, after a quick discussion, we settled somewhere in the middle of both
approaches. We again have all leaders end with a 1&#215;1 pixel, but we don&rsquo;t
check these pixels&rsquo; x-coordinates. Instead, they have a style attribute that we
query for (at the moment, this is the <code>text-align</code> attribute, but this may
change in the future). The code now looks like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">do_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Not implemented, use `add(widget, svg_id)` instead.&#34;&#34;&#34;</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">,</span> <span class="n">svg_id</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Adds the given widget to the map, bound to the given SVG element
</span><span class="s2">    identifier. If the element identifier or its leader is not found in the
</span><span class="s2">    SVG, the widget is not added.
</span><span class="s2">
</span><span class="s2">    @param widget The widget to add, as Gtk.Widget
</span><span class="s2">    @param svg_id The identifier of the SVG element with which this widget
</span><span class="s2">                  is to be paired, as str
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="n">svg_leader</span> <span class="o">=</span> <span class="n">svg_id</span> <span class="o">+</span> <span class="s2">&#34;-leader&#34;</span>
    <span class="k">if</span> <span class="n">widget</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">svg_id</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> \
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span class="n">has_sub</span><span class="p">(</span><span class="n">svg_id</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span class="n">has_sub</span><span class="p">(</span><span class="n">svg_leader</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="n">is_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpath_has_style</span><span class="p">(</span><span class="n">svg_leader</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s2">&#34;text-align:end&#34;</span><span class="p">)</span>
    <span class="n">child</span> <span class="o">=</span> <span class="n">_MouseMapChild</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">is_left</span><span class="p">,</span> <span class="n">svg_id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&#34;enter-notify-event&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_enter</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&#34;leave-notify-event&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_leave</span><span class="p">)</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code></pre></div>
<p>As you can see, we use <a href="https://www.w3schools.com/xml/xpath_intro.asp">XPath</a> to query the XML tree for style
attributes. It&rsquo;s implemented like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">_xpath_has_style</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">svg_id</span><span class="p">,</span> <span class="n">style</span><span class="p">):</span>
    <span class="c1"># Checks if the SVG element with the given identifier has the given</span>
    <span class="c1"># style attribute set.</span>
    <span class="n">namespaces</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;sodipodi&#39;</span><span class="p">:</span> <span class="s1">&#39;http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cc&#39;</span><span class="p">:</span> <span class="s1">&#39;http://web.resource.org/cc/&#39;</span><span class="p">,</span>
        <span class="s1">&#39;svg&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.w3.org/2000/svg&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dc&#39;</span><span class="p">:</span> <span class="s1">&#39;http://purl.org/dc/elements/1.1/&#39;</span><span class="p">,</span>
        <span class="s1">&#39;xlink&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.w3.org/1999/xlink&#39;</span><span class="p">,</span>
        <span class="s1">&#39;rdf&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.w3.org/1999/02/22-rdf-syntax-ns#&#39;</span><span class="p">,</span>
        <span class="s1">&#39;inkscape&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.inkscape.org/namespaces/inkscape&#39;</span>
    <span class="p">}</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&#34;//svg:rect[@id=</span><span class="se">\&#34;</span><span class="s2">{}</span><span class="se">\&#34;</span><span class="s2">][contains(@style, </span><span class="se">\&#34;</span><span class="s2">{}</span><span class="se">\&#34;</span><span class="s2">)]&#34;</span><span class="o">.</span>\
            <span class="n">format</span><span class="p">(</span><span class="n">svg_id</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
    <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_svg_data</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span></code></pre></div>
<p>The attentive reader may have noticed the <code>_MouseMapChild</code> class. This is an
implementation detail (hence it is private) to capture all data related to
children:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">_MouseMapChild</span><span class="p">:</span>
    <span class="c1"># A helper class to manage children and their properties.</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">,</span> <span class="n">is_left</span><span class="p">,</span> <span class="n">svg_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_widget</span> <span class="o">=</span> <span class="n">widget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_left</span> <span class="o">=</span> <span class="n">is_left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_svg_id</span> <span class="o">=</span> <span class="n">svg_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_svg_leader</span> <span class="o">=</span> <span class="n">svg_id</span> <span class="o">+</span> <span class="s2">&#34;-leader&#34;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">widget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The widget belonging to this child.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widget</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">svg_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The identifier of the SVG element with which this child&#39;s widget is</span>
        <span class="c1"># paired.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_svg_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">svg_leader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The identifier of the leader SVG element with which this child&#39;s</span>
        <span class="c1"># widget is paired.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_svg_leader</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># True iff this child&#39;s widget is allocated to the left of the SVG.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_left</span></code></pre></div>
<p>To calculate the preferred width with left and right aligned children, we simply
iterate over the children and take for each side the maximum width:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">do_get_preferred_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Calculates the container&#39;s initial minimum and natural width. While
</span><span class="s2">    this call is specific to height-for-width requests (that we requested
</span><span class="s2">    not to get) we cannot be certain that our wishes are granted and hence
</span><span class="s2">    we must implement this method as well. We return the sum of the SVG&#39;s
</span><span class="s2">    width, the natural child widths (left and right), spacing and border
</span><span class="s2">    width.
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">border_width</span>
    <span class="n">width_svg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">width</span>
    <span class="n">width_left</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">child</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">get_preferred_width</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span>
                      <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_children</span> <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">is_left</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">width_right</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">child</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">get_preferred_width</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span>
                      <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_children</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">child</span><span class="o">.</span><span class="n">is_left</span><span class="p">),</span>
                      <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">+=</span> <span class="n">width_left</span> <span class="o">+</span> <span class="n">width_svg</span> <span class="o">+</span> <span class="n">width_right</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span>
    <span class="k">if</span> <span class="n">width_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span></code></pre></div>
<p>Because we cannot reliably calculate whether children are positioned above or
below the SVG (the SVG elements may have arbitrary coordinates), we simply
assume that the SVG is tall enough to fit all children (which works because we
have control over the SVGs):</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">do_get_preferred_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Calculates the container&#39;s initial minimum and natural height. While
</span><span class="s2">    this call is specific to width-for-height requests (that we requested
</span><span class="s2">    not to get) we cannot be certain that our wishes are granted and hence
</span><span class="s2">    we must implement this method as well. We just return the SVG&#39;s height
</span><span class="s2">    plus the border widths.
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="c1"># TODO: account for children sticking out under or above the SVG, if</span>
    <span class="c1"># they exist. At the moment we cannot reliably do so because the</span>
    <span class="c1"># y-coordinates of the leaders can have any arbitrary value. For now,</span>
    <span class="c1"># we assume that the SVG is high enough to fit all children and do not</span>
    <span class="c1"># worry about setups beyond the default GNOME Adwaita.</span>
    <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">height</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">border_width</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span></code></pre></div>
<p>Finally, the coordinate system is now centric to the SVG with its origin to the
top left of the SVG such that the MouseMap will be drawn in the center of its
allocated width (this also shows how the highlighting is now done using masks,
as discussed in the previous blog entry):</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">do_size_allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allocation</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Assigns a size and position to the child widgets. Children may
</span><span class="s2">    adjust the given allocation in their adjust_size_allocation virtual
</span><span class="s2">    method implementation.
</span><span class="s2">
</span><span class="s2">    @param allocation The position and size allocated to this container, as
</span><span class="s2">                      Gdk.Rectangle
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_allocation</span><span class="p">(</span><span class="n">allocation</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_to_origin</span><span class="p">()</span>
    <span class="n">child_allocation</span> <span class="o">=</span> <span class="n">Gdk</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_children</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">child</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">get_visible</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">svg_geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_svg_sub_geometry</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">svg_leader</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nat_size</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">get_preferred_size</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">is_left</span><span class="p">:</span>
            <span class="n">child_allocation</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">svg_geom</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="o">-</span> <span class="n">nat_size</span><span class="o">.</span><span class="n">width</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">child_allocation</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">svg_geom</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span>
        <span class="n">child_allocation</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">svg_geom</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">svg_geom</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">nat_size</span><span class="o">.</span><span class="n">height</span>
        <span class="n">child_allocation</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">nat_size</span><span class="o">.</span><span class="n">width</span>
        <span class="n">child_allocation</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">nat_size</span><span class="o">.</span><span class="n">height</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">child</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">get_has_window</span><span class="p">():</span>
            <span class="n">child_allocation</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">allocation</span><span class="o">.</span><span class="n">x</span>
            <span class="n">child_allocation</span><span class="o">.</span><span class="n">y</span> <span class="o">+=</span> <span class="n">allocation</span><span class="o">.</span><span class="n">y</span>
        <span class="n">child</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">size_allocate</span><span class="p">(</span><span class="n">child_allocation</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">do_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Draws the container to the given Cairo context. The top left corner
</span><span class="s2">    of the widget will be drawn to the currently set origin point of the
</span><span class="s2">    context. The container needs to propagate the draw signal to its
</span><span class="s2">    children.
</span><span class="s2">
</span><span class="s2">    @param cr The Cairo context to draw into, as cairo.Context
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="n">cr</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_to_origin</span><span class="p">()</span>
    <span class="n">cr</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_draw_device</span><span class="p">(</span><span class="n">cr</span><span class="p">)</span>
    <span class="n">cr</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_children</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propagate_draw</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">widget</span><span class="p">,</span> <span class="n">cr</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_translate_to_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Translates the coordinate system such that the SVG and its buttons</span>
    <span class="c1"># will be drawn in the center of the allocated space. The returned x-</span>
    <span class="c1"># and y-coordinates will be the top left corner of the centered SVG.</span>
    <span class="n">allocation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_allocation</span><span class="p">()</span>
    <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_preferred_width</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_preferred_height</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">width_left</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">child</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">get_preferred_width</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span>
                      <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_children</span> <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">is_left</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">width_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">width_left</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span>

    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">allocation</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">border_width</span> <span class="o">+</span> <span class="n">width_left</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">allocation</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">border_width</span>
    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_draw_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
    <span class="c1"># Draws the SVG into the Cairo context. If there is an element to be</span>
    <span class="c1"># highlighted, it will do as such in a separate surface which will be</span>
    <span class="c1"># used as a mask over the device surface.</span>
    <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_style_context</span><span class="p">()</span><span class="o">.</span><span class="n">get_color</span><span class="p">(</span><span class="n">Gtk</span><span class="o">.</span><span class="n">StateFlags</span><span class="o">.</span><span class="n">LINK</span><span class="p">)</span>
    <span class="n">cr</span><span class="o">.</span><span class="n">set_source_rgba</span><span class="p">(</span><span class="n">color</span><span class="o">.</span><span class="n">red</span><span class="p">,</span> <span class="n">color</span><span class="o">.</span><span class="n">green</span><span class="p">,</span> <span class="n">color</span><span class="o">.</span><span class="n">blue</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span class="n">render_cairo_sub</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&#34;#Device&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_highlight_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">svg_surface</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">get_target</span><span class="p">()</span>
        <span class="n">highlight_surface</span> <span class="o">=</span> <span class="n">svg_surface</span><span class="o">.</span><span class="n">create_similar</span><span class="p">(</span><span class="n">cairo</span><span class="o">.</span><span class="n">Content</span><span class="o">.</span><span class="n">COLOR_ALPHA</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
        <span class="n">highlight_context</span> <span class="o">=</span> <span class="n">cairo</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">highlight_surface</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span class="n">render_cairo_sub</span><span class="p">(</span><span class="n">highlight_context</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_highlight_element</span><span class="p">)</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">mask_surface</span><span class="p">(</span><span class="n">highlight_surface</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span class="n">render_cairo_sub</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_layer</span><span class="p">)</span></code></pre></div>
<p>All this work leads to the below video. You can find the pull request
<a href="https://github.com/libratbag/piper/pull/20">here</a>.</p>

<video controls>
  <source src="/img/blog/gsoc-part-6/mousemap.webm" type="video/webm">
Your browser does not support the video tag.
</video>

<h3 id="in-progress-reimplementing-piper-according-to-the-new-mockups">In progress: reimplementing Piper according to the new mockups</h3>

<p>As you can see from the video, I have started with a rough implementation of the
new window:</p>

<video controls>
  <source src="/img/blog/gsoc-part-6/window.webm" type="video/webm">
Your browser does not support the video tag.
</video>

<p>Next week I will attempt to implement the resolutions and begin with the
buttons!</p>

<p>This blog post is part of a <a href="/series/google-summer-of-code/">series</a>. You can read the next part about the
resolutions stack page <a href="/blog/gsoc-part-7">here</a> or the previous part
<a href="/blog/gsoc-part-5">here</a>.</p>

</div>

<div id="postamble">
  <footer>
    <nav class="social-icons">
       
        <a href="mailto:hjdskes@gmail.com" title="Send a mail to hjdskes@gmail.com">
          <svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
            <polyline points="22,6 12,13 2,6"/>
          </svg>
        </a>
      

       
        <a href="https://twitter.com/Hjdskes" title="Hjdskes on Twitter" rel=me>
          <svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true">
            <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
	  </svg>
	</a>
      

       
        <a href="https://github.com/Hjdskes" title="Hjdskes on GitHub" rel=me>
          <svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true">
            <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
	  </svg>
        </a>
      

       
        <a href="https://gitlab.gnome.org/Hjdskes" title="Hjdskes on GNOME GitLab" rel=me>
	  <svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true">
	    <path d="M 10.788594,21.536734 C 7.1281588,20.923645 3.4317212,17.61669 3.8926704,13.669554 5.0660949,10.030121 9.4084325,9.002481 12.797722,9.0110661 c 3.127309,-0.7108099 5.300956,3.1584089 2.079944,4.7634329 -1.481971,1.481121 -6.562787,2.039887 -4.51544,4.8592 2.462629,2.050335 2.533426,-3.290017 5.338069,-2.15334 2.796365,0.976146 -0.163921,4.247454 -1.950641,4.696159 -0.921233,0.406032 -1.969188,0.530203 -2.96106,0.360216 z m 1.794295,-0.08356 c 2.705909,0.255118 6.301544,-4.993159 1.916049,-4.963018 -1.21743,1.167328 -3.784248,4.539961 -4.6998222,1.26491 0.2709802,-2.794652 3.8307952,-2.615115 5.4170302,-4.401817 2.651498,-1.633928 0.402305,-4.7420327 -2.166648,-4.246326 -3.3777465,-0.078097 -7.6444164,0.902415 -9.0000509,4.382807 -0.7054739,4.120455 3.3766681,7.576214 7.1722609,7.993766 0.453028,0.03846 0.910413,0.03039 1.361181,-0.03032 z M 3.9341566,10.427154 C 1.0490542,10.268445 3.2537383,5.1108327 4.7476099,8.3812657 5.0657664,9.1042431 5.0182823,10.460582 3.9341566,10.427154 Z M 4.4699344,10.30542 C 6.4977819,8.6779325 1.9003316,5.8776241 2.5877993,9.0260669 2.867495,9.7751822 3.6284369,10.422289 4.4699344,10.30542 Z M 6.7053902,8.5039933 C 3.6297286,7.8857682 6.6102452,2.4753402 7.9003551,6.1902266 8.0932518,7.0711831 7.829542,8.4523085 6.7053902,8.5039933 Z M 7.2746339,8.3298088 C 9.5332904,6.6816546 5.5180564,3.0049367 5.420685,6.6249745 5.5254822,7.5087681 6.2635101,8.5559472 7.2746339,8.3298088 Z M 14.642553,8.2311668 C 12.2283,6.5368719 14.541155,2.985536 16.840519,2.5219305 20.261447,1.9328509 20.0109,6.206991 17.399643,7.2088589 16.626868,7.8315576 15.666748,8.3385955 14.642553,8.2311668 Z M 15.768655,8.050831 c 2.864892,-0.3134359 5.553252,-6.0915541 0.966528,-5.299797 -2.55054,0.123197 -4.819128,5.8325044 -0.966528,5.299797 z M 10.185719,7.5115241 c -3.3583369,-1.5986324 1.671427,-6.90260758 1.965159,-2.311667 -0.105682,1.0279546 -0.733901,2.3978164 -1.965159,2.311667 z m 0.606495,-0.09287 C 13.232178,6.592527 11.605766,1.4635609 9.4839173,4.2607729 8.9204646,5.3532178 9.2561462,7.4217666 10.792214,7.4186541 Z"/>
	  </svg>
	</a>
      

       
        <a href="https://hjdskes.nl/index.xml" title="RSS feed">
          <svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true">
            <path d="M4 11a9 9 0 0 1 9 9"/>
	    <path d="M4 4a16 16 0 0 1 16 16"/>
	    <circle cx="5" cy="19" r="1"/>
	  </svg>
        </a>
      
    </nav>

    <div id="license-note">
      <a href="/license">Copyright © 2016-2018 Jente Hidskes</a>
    </div>
  </footer>
</div>

<link rel="stylesheet" type="text/css" href="/css/syntax.css"/>
<link rel="stylesheet" type="text/css" href="/css/zoom.css"/>
<script defer type="text/javascript" src="/js/zoom-vanilla.js"></script>
<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', function() {
    images = document.querySelectorAll("img[data-action=\"zoom\"]");
    images.forEach(function(image) {
      image.style.display = "block";
    })
  }, false);
</script>

</body>
</html>

