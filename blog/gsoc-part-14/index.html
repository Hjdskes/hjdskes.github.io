<!DOCTYPE html>
<html lang="en-us">

<head>
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="Jente Hidskes&#39; website">


<meta property="og:site_name" content="Jente Hidskes&#39; website" />
<meta property="og:locale" content="nn_NO" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hjdskes.nl/blog/gsoc-part-14/" />
<meta property="og:title" content="GSoC part 14: final code changes" />
<meta property="twitter:title" content="GSoC part 14: final code changes">

    <meta property="twitter:card" content="summary">

<meta property="og:description" content="GSoC blog series on rewriting Piper">
<meta property="twitter:description" content="GSoC blog series on rewriting Piper">

<title>


     Jente Hidskes&#39; website - GSoC part 14: final code changes 

</title>
<link rel="canonical" href="https://hjdskes.nl/blog/gsoc-part-14/">


<style media="screen">
  @font-face {
  font-family: 'Nexa Bold';
  src: url('https://hjdskes.nl/fonts/Nexa Bold.otf');
}

html, body, div, span, applet, object, iframe,
h1, h2, h3, h4, h5, h6, p, blockquote, pre,
a, abbr, acronym, address, big, cite, code,
del, dfn, em, img, ins, kbd, q, s, samp,
small, strike, strong, sub, tt, var,
b, u, i, center,
dl, dt, dd, ol, ul, li,
fieldset, form, label, legend,
table, caption, tbody, tfoot, thead, tr, th, td,
article, aside, canvas, details, embed,
figure, figcaption, footer, header, hgroup,
menu, nav, output, ruby, section, summary,
time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
  font-size: 100%;
  font: inherit;
  vertical-align: baseline;
}
/* HTML5 display-role reset for older browsers */
article, aside, details, figcaption, figure,
footer, header, hgroup, menu, nav, section, div.column {
  display: block;
}
body {
  line-height: 1;
}
ol, ul {
  list-style: none;
}
blockquote, q {
  quotes: none;
}
blockquote:before, blockquote:after,
q:before, q:after {
  content: '';
  content: none;
}
table {
  border-collapse: collapse;
  border-spacing: 0;
}

*,
*:before,
*:after {
  box-sizing: border-box;
}
a,
a:visited,
a:focus,
a:active {
  text-decoration: none;
}
html {
  height: 100%;
  font-size: 16px;
}
body {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: column;
  -moz-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  -webkit-justify-content: flex-start;
  -moz-justify-content: flex-start;
  -ms-justify-content: flex-start;
  justify-content: flex-start;
  width: 100%;
  min-height: 100%;
  font-weight: 400;
  font-family: 'Helvetica Neue', 'Arial', sans-serif;
  color: #111111;
  line-height: 1.6;
  text-rendering: optimizeLegibility !important;
}
.icon {
  text-rendering: geometricPrecision !important;
}
section {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-justify-content: center;
  -moz-justify-content: center;
  -ms-justify-content: center;
  justify-content: center;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  width: 100%;
}
div.column {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-justify-content: center;
  -moz-justify-content: center;
  -ms-justify-content: center;
  justify-content: center;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  width: 100%;
}
.container {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  width: 100%;
}
div.header .container {
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  -webkit-justify-content: center;
  -moz-justify-content: center;
  -ms-justify-content: center;
  justify-content: center;
}
div.header .content {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: column;
  -moz-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
}
div.header .container .logo {
  max-width: 100px;
  margin-left: -2em;
}
div.header .name {
  padding-top: 20px;
  font-size: 28px;
  font-family: 'Nexa Bold', 'Helvetica Neue', 'Arial', sans-serif;
  letter-spacing: -0.005rem;
  text-transform: uppercase;
  -moz-osx-font-smoothing: grayscale;
  -webkit-font-smoothing: antialiased;
  font-smoothing: antialiased;
  color: #333333;
  color: #555555;
}
div.header nav {
  margin-bottom: 16px;
}
div.header nav ul {
  list-style: none;
  text-align: center;
  display: -webkit-inline-flex;
  display: -moz-inline-flex;
  display: -ms-inline-flexbox;
  display: -ms-inline-flex;
  display: inline-flex;
}
div.header nav ul li {
  margin-left: 6px;
  margin-right: 6px;
}
div.header nav ul li:first-child {
  margin-left: 0;
}
div.header nav ul li:last-child {
  margin-right: 0;
}
div.header nav ul a {
  color: #555555;
  font-weight: 400;
  font-size: 14px;
  text-transform: uppercase;
  font-family: 'Helvetica Neue', 'Arial', sans-serif;
  -webkit-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -moz-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -ms-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -o-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
}
div.header nav ul a:hover {
  color: #111111;
}
div.footer .container {
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  -webkit-justify-content: center;
  -moz-justify-content: center;
  -ms-justify-content: center;
  justify-content: center;
  flex-direction: column-reverse;
  width: 100%;
  text-align: center;
}
div.footer .container a {
  font-size: 14px;
  margin-left: 6px;
  margin-right: 6px;
  opacity: 0.6;
  -webkit-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -moz-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -ms-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -o-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
}
div.footer .container a:first-child {
  margin-left: 0;
}
div.footer .container a:last-child {
  margin-right: 0;
}
div.footer .container a:hover {
  opacity: 0.8;
}
div.footer .container a .icon {
  width: 16px;
  height: 16px;
}
div.footer .container .copyright {
  flex-grow: 0.5;
  text-align: start;
}
div.footer .container .icons {
  flex-grow: 0.5;
  text-align: end;
}
div.main .container {
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  -webkit-justify-content: flex-start;
  -moz-justify-content: flex-start;
  -ms-justify-content: flex-start;
  justify-content: flex-start;
}
div.main .content {
  color: #111111;
  font-size: 16px;
}
div.main .content .title-container {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-justify-content: space-between;
  -moz-justify-content: space-between;
  -ms-justify-content: space-between;
  justify-content: space-between;
}
div.main .content .posts {
  margin-bottom: 4em;
}
div.main .content .page-heading {
  font-size: 20px;
  font-weight: 700;
  font-family: 'Helvetica Neue', 'Arial', sans-serif;
  letter-spacing: -0.005rem;
  text-transform: uppercase;
  -moz-osx-font-smoothing: grayscale;
  -webkit-font-smoothing: antialiased;
  font-smoothing: antialiased;
  color: #333333;
  margin-bottom: 16px;
}
div.main .content .front-matter .page-heading {
  margin-bottom: 0;
}
div.main .content .front-matter .meta {
  font-size: 14px;
  color: #666666;
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  margin-bottom: 32px;
}
div.main .content .front-matter .date,
div.main .content .front-matter .author,
div.main .content .front-matter .tags,
div.main .content .front-matter .word-count,
div.main .content .front-matter .middot:before {
  display: none;
}
div.main .content .front-matter .middot:before {
  font-size: 6px;
  margin: 0 6px;
  vertical-align: middle;
  content: "•";
}
div.main .content .front-matter .tags ul {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: row;
  -moz-flex-direction: row;
  -ms-flex-direction: row;
  flex-direction: row;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
}
div.main .content .front-matter .tags ul li {
  -webkit-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -moz-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -ms-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -o-transition: opacity 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
}
div.main .content .front-matter .tags ul li:hover {
  opacity: 0.7;
}
div.main .content .front-matter .tags ul li a {
  color: #666666;
}
div.main .container.f04 {
  -webkit-justify-content: center;
  -moz-justify-content: center;
  -ms-justify-content: center;
  justify-content: center;
}
div.main .container.f04 .content {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: column;
  -moz-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
}
div.main .container.f04 .content .num {
  margin: 30px 0px 30px 0;
  font-weight: 400;
  font-family: 'Helvetica Neue', 'Arial', sans-serif;
  font-size: 50px;
}
div.main .container.f04 .content .detail {
  margin-bottom: 40px;
}
div.main .container .content .groupby {
  margin-top: 1em;
  padding-left: 0.5em;
}
div.main .container .content .post-item {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  display: list-item;
  list-style: disc inside;
}
div.main .container .content .post-item .meta {
  font-size: 14px;
  color: #666666;
  display: none;
  min-width: 100px;
}
div.main .container .content .see-more {
  font-style: italic;
  float: right;
  font-size: 0.9em;
  margin-top: 2em;
  color: #313537;
}
div.main .container .content .see-more:hover {
  color: #666;
}
section {
  padding: 0 16px;
}
div.column {
  padding: 0 16px;
}
div.header {
  padding-top: 10px;
}
div.header-home {
  padding-top: 36px;
}
div.main {
  padding-top: 32px;
}
div.main .container .content .post-item .meta {
    display: block;
}
div.main .container .content .post-item {
    display: flex;
    list-style: none;
}
a {
  color: #428bca;
  -webkit-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -moz-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -ms-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
  -o-transition: color 0.1s cubic-bezier(0.47, 0, 0.75, 0.72);
}
a:hover {
  color: #2a6496;
}
img {
  max-width: 100%;
}
div.main .content {
    width: 100%;
}
div.main .content .markdown {
  font-size: 1.1em;
  line-height: 1.75em;
  color: #313537;
  font-family: serif;
  font-weight: 300;
}
div.main .content .markdown h1,
div.main .content .markdown h2,
div.main .content .markdown h3,
div.main .content .markdown h4,
div.main .content .markdown h5,
div.main .content .markdown h6 {
  font-size: 22px;
  font-family: 'Helvetica Neue', 'Arial', sans-serif;
  letter-spacing: -0.005rem;
  font-weight: 700;
  -moz-osx-font-smoothing: grayscale;
  -webkit-font-smoothing: antialiased;
  font-smoothing: antialiased;
  color: #333333;
  text-transform: none;
  margin-top: 1.75rem;
}
div.main .content .markdown h1 {
  font-size: 1.75rem;
  margin-bottom: 2rem;
}
div.main .content .markdown h2 {
  font-size: 1.5rem;
  margin-bottom: 1.5rem;
}
div.main .content .markdown h3 {
  font-size: 1em;
  margin-bottom: 1rem;
}
div.main .content .markdown h4,
div.main .content .markdown h5,
div.main .content .markdown h6 {
  font-size: 1rem;
  margin-bottom: 1rem;
  letter-spacing: none;
}
div.main .content .markdown code,
div.main .content .markdown pre {
  font-family: 'Menlo', monospace;
  font-size: 0.98rem;
  background-color: #f7f7f7;
}
div.main .content .markdown code {
  /* enclosed by single backtick (`) */
  padding: .15em .5em;
  border-radius: 2px;
}
div.main .content .markdown pre {
  /* Hugo specific: consider using the 'highlight' shortcode */
  display: block;
  margin-top: 1rem;
  margin-bottom: 2rem;
  padding: 1rem;
  line-height: 1.5em;
  white-space: pre;
  word-break: break-all;
  word-wrap: break-word;
}
div.main .content .markdown pre code {
  /* enclosed by 4 backticks (````) */
  padding: 0;
  font-size: 0.9rem;
}
div.main .content .markdown a code {
  color: #428bca !important;
}
div.main .content .markdown a code:hover {
  text-decoration: underline;
}
div.main .content .markdown p {
  
  text-align: justify;
  
  margin-top: 0;
  margin-bottom: 1em;
}
div.main .content .markdown ul,
div.main .content .markdown ol,
div.main .content .markdown dl {
  margin-top: 1rem;
  margin-bottom: 2rem;
}
div.main .content .markdown dt {
  font-weight: bold;
}
div.main .content .markdown dd {
  margin-bottom: .5rem;
}
div.main .content .markdown ul {
  list-style-type: disc;
  list-style-position: outside;
  margin-bottom: 1.25rem;
}
div.main .content .markdown ol {
  list-style-type: decimal;
  margin-bottom: 1.25rem;
}
div.main .content .markdown li {
  margin-left: 2em;
}
div.main .content .markdown em {
  font-style: italic;
}
div.main .content .markdown strong {
  font-weight: 700;
}
div.main .content .markdown hr {
  position: relative;
  margin: 1.75rem 0;
  border: 0;
  border-top: 1px solid #808080;
  border-top: 1px solid #999999;
}
div.main .content .markdown abbr {
  font-size: 0.85rem;
  font-weight: bold;
  color: #666666;
  text-transform: uppercase;
}
div.main .content .markdown abbr[title] {
  cursor: help;
  border-bottom: 1px dotted #808080;
}
div.main .content .markdown blockquote {
  padding: .5rem 1rem;
  margin: .8rem 0;
  color: #7a7a7a;
  border-left: .25rem solid #e5e5e5;
}
div.main .content .markdown blockquote p:last-child {
  margin-bottom: 0;
}
div.main .content .markdown figure {
  width: 100%;
  background: #fff;
  margin-bottom: 1em;
}
div.main .content .markdown figure img {
  width: 100%;
  height: auto;
  max-width: 100%;
  display: block;
  position: static;
  margin: auto;
}
div.main .content .markdown table {
  margin-bottom: 1rem;
  width: 100%;
  border: 1px solid #e5e5e5;
  border-collapse: collapse;
}
div.main .content .markdown td,
div.main .content .markdown th {
  padding: .25rem .5rem;
  border: 1px solid #e5e5e5;
}
div.main .content .markdown tbody tr:nth-child(odd) td,
div.main .content .markdown tbody tr:nth-child(odd) th {
  background-color: #f7f7f7;
}
div.main .content .markdown .footnotes ol {
  list-style-type: decimal;
  margin-left: 16px;
}
div.main .content .markdown .footnotes li {
  list-style-type: unset;
}
div.main .content .markdown .footnote-ref {
  font-size: 0.7em;
}
div.main .content .navigation {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: column;
  -moz-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  padding: 2em;
}
div.main .content .navigation div {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: row;
  -moz-flex-direction: row;
  -ms-flex-direction: row;
  flex-direction: row;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  margin-top: 1em;
}
div.main .content .navigation .icon {
  width: 16px;
  height: 16px;
}
div.main .content .navigation a {
  width: 250px;
  margin: 0 1em;
  text-align: center;
  font-style: italic;
  color: #313537;
}
div.main .content .share, div.main .content .share div {
  display: -webkit-flex;
  display: -moz-flex;
  display: -ms-flexbox;
  display: -ms-flex;
  display: flex;
  -webkit-flex-direction: row;
  -moz-flex-direction: row;
  -ms-flex-direction: row;
  flex-direction: row;
  -webkit-align-items: center;
  -moz-align-items: center;
  -ms-align-items: center;
  align-items: center;
  justify-content: center;
}
div.main .content .share {
  background-color: rgba(152, 152, 152, 0.07);
  padding: 1em 0;
}
div.main .content .share a {
  margin: 0 6px;
}
kbd {
  padding: 0.1em 0.6em;
  border: 1px solid #ccc;
  font-size: 11px;
  font-family: Arial,Helvetica,sans-serif;
  background-color: #f7f7f7;
  color: #333;
  -moz-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;
  -webkit-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;
  box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;
  -moz-border-radius: 3px;
  -webkit-border-radius: 3px;
  border-radius: 3px;
  display: inline-block;
  margin: 0 0.1em;
  text-shadow: 0 1px 0 #fff;
  line-height: 1.4;
  white-space: nowrap;
}

/* Fonts */



</style>
<style media="(min-width: 600px)">
  body {
-webkit-justify-content: center;
-moz-justify-content: center;
-ms-justify-content: center;
justify-content: center;
}
.non-narrow.zero-top-spacing {
padding-top: 0 !important;
}
section {
padding: 0 16px;
margin-left: 100px;
margin-right: 100px;
max-width: 750px;
}
div.column {
padding: 0 16px;
margin-left: 100px;
margin-right: 100px;
max-width: 750px;
}
div.header {
background-color: transparent;
}
div.header .container {
-webkit-justify-content: flex-start;
-moz-justify-content: flex-start;
-ms-justify-content: flex-start;
justify-content: flex-start;
}
div.header .container .logo {
margin: 0;
}
div.header-home .container .logo {
max-width: 180px;
margin-left: 20px;
}
div.header-home .name-home {
padding-top: 30px;
font-size: 40px;
}
div.header-home nav ul a {
font-size: 18px;
}
div.header .content {
-webkit-align-items: flex-start;
-moz-align-items: flex-start;
-ms-align-items: flex-start;
align-items: flex-start;
}
div.header .name {
color: #333333;
}
div.header nav {
font-size: 14px;
margin-bottom: 0;
}
div.header nav ul {
text-align: left;
}
div.header nav ul a {
color: #666666;
}
div.header nav ul a:hover {
color: #333333;
}
div.footer {
background-color: transparent;
}
div.footer .container {
flex-direction: row;
}
div.footer .container a {
margin-left: 3px;
margin-right: 3px;
color: #666666;
}
div.footer .container a:hover {
color: #333333;
}
div.footer .container a .icon {
font-size: 18px;
}
div.footer .container a .icon.larger {
font-size: 20px;
}
div.main .content .front-matter .date,
div.main .content .front-matter .author,
div.main .content .front-matter .tags,
div.main .content .front-matter .word-count,
div.main .content .front-matter .middot:before {
display: initial;
}
div.main .container.f04 {
-webkit-justify-content: flex-start;
-moz-justify-content: flex-start;
-ms-justify-content: flex-start;
justify-content: flex-start;
}
div.main .container.f04 .content {
-webkit-align-items: flex-start;
-moz-align-items: flex-start;
-ms-align-items: flex-start;
align-items: flex-start;
}
div.main .container.f04 .content .num {
margin: 0 0 10px 0;
font-size: 32px;
}
div.main .container.f04 .content .detail {
margin-bottom: 30px;
}
.container {
padding: 0 30px;
}
div.header {
padding-top: 60px;
padding-bottom: 60px;
}
div.footer {
padding-top: 30px;
padding-bottom: 60px;
}
div.main {
padding-top: 0;
}
div.main .container .content .post-item {
display: flex;
list-style: none;
padding-left: 1.5em;
}
div.main .container .content .post-item .meta {
display: block;
}
div.main.post {
padding-top: 60px;
padding-bottom: 60px;
}
div.main .content .markdown blockquote {
padding-right: 5rem;
padding-left: 1.25rem;
}
div.main .content .navigation {
-webkit-flex-direction: row;
-moz-flex-direction: row;
-ms-flex-direction: row;
flex-direction: row;
}
div.main .content .navigation div {
margin-top: 0em;
}

</style>
<style media="(min-width: 769px)">
  div.main .content .markdown figure {
width: 110%;
margin-left: -4%;
}
div.main .content .markdown img {
max-width: 110%;
width: 110%;
margin-left: -4%;
}
div.main .content .markdown pre {
width: 110%;
margin-left: -4%;
}

</style>

<noscript>
  <link href="https://fonts.googleapis.com/css?family=Raleway:400,600,700" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Merriweather:300,300i,700,700i" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700" rel="stylesheet">
</noscript>


  <style type="text/css" media="screen">
    .hljs-comment,.hljs-quote{color:#8e908c}.hljs-variable,.hljs-template-variable,.hljs-tag,.hljs-name,.hljs-selector-id,.hljs-selector-class,.hljs-regexp,.hljs-deletion{color:#c82829}.hljs-number,.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-type,.hljs-params,.hljs-meta,.hljs-link{color:#f5871f}.hljs-attribute{color:#eab700}.hljs-string,.hljs-symbol,.hljs-bullet,.hljs-addition{color:#718c00}.hljs-title,.hljs-section{color:#4271ae}.hljs-keyword,.hljs-selector-tag{color:#8959a8}.hljs{display:block;overflow-x:auto;background:white;color:#4d4d4c;padding:0.5em}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:bold}
  </style>









  <link rel="stylesheet" href="https://hjdskes.nl/css/message.css">

  <link rel="stylesheet" href="https://hjdskes.nl/css/gallery.css">

  <link rel="stylesheet" href="https://hjdskes.nl/css/cocoa-eh-fixes.css">





<link rel="shortcut icon"

    href="https://hjdskes.nl/img/favicon.ico"

>




</head>


<body>


<div class="header column">

    <div class="container">
        <a href="https://hjdskes.nl/"><img class="logo" src="https://hjdskes.nl/img/avatar.png" alt="logo" /></a>
        <div class="content">
            <a href="https://hjdskes.nl/"><div class="name"><h1>Jente Hidskes&#39; website</h1></div></a>
            <nav>
                <ul>
                    
                        <li><a href="https://hjdskes.nl/blog/">Blog</a></li>
                    
                    
                        
                            
                        
                    
                        
                            
                            <li><a href="https://hjdskes.nl/contributions">contributions</a></li>
                            
                        
                    
                        
                            
                            <li><a href="https://hjdskes.nl/projects">projects</a></li>
                            
                        
                    
                    
                        
                            <li><a href="https://hjdskes.nl/about/">About me</a></li>
                        
                    
                        
                    
                        
                    
                </ul>
            </nav>
        </div>
    </div>
</div>


<div class="main post non-narrow zero-top-spacing column">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    GSoC part 14: final code changes

</div>

                </div>
                <div class="meta">
                    <div class="date" title="Wed Aug 23 2017 13:01:32 CEST">Aug 23, 2017</div>
                    
                        
                    
                    <div class="reading-time middot">7 minute read</div>
                    <div class="tags">
                        <ul>
                          
                            <li class="middot"><a href="/tags/piper">Piper</a> </li>
                          
                            <li class="middot"><a href="/tags/fdo">fdo</a> </li>
                          
                            <li class="middot"><a href="/tags/macro">macro</a> </li>
                          
                            <li class="middot"><a href="/tags/localization">localization</a> </li>
                          
                            <li class="middot"><a href="/tags/property">property</a> </li>
                          
                            <li class="middot"><a href="/tags/exception">exception</a> </li>
                          
                        </ul>
                    </div>
                    <div class="tags">
                        <ul>
                          
                          
                        </ul>
                    </div>
                </div>
            </div>
            <div class="markdown">
                
    

<p><img src="/img/blog/gsoc-part-1/GSoC-logo-horizontal.svg" alt="GSoC logo horizontal" /></p>

<p>Well, this really is the last week of my Summer of Code! This will be a short
update on the final changes made since my <a href="/blog/gsoc-part-13">last update</a> on
Friday, which will be followed by a proper blog post for my final submission
later this week.</p>

<p>Last week I mentioned a few items that were
<a href="/blog/gsoc-part-13#work-in-progress">work-in-progress</a>. The search field for
the button mapping dialog has been merged, including its revamp of the dialog&rsquo;s
UI. The resolutions stack page now highlights the active resolution within the
list, and, most importantly, Piper can now be translated completely into your
native language! Here&rsquo;s Piper fully translated in Dutch:</p>

<video controls>
  <source src="/img/blog/gsoc-part-14/dutch.webm" type="video/webm">
Your browser does not support the video tag.
</video>

<p>I also reported on the work that was still to be done, which we&rsquo;ll get to now.</p>

<h3 id="piper-shouldn-t-crash-when-libratbag-returns-an-error">Piper shouldn&rsquo;t crash when libratbag returns an error</h3>

<p>Libratbag returns error codes to clients over DBus, it can for example return
<code>RATBAG_ERROR_CAPABILITY</code> that has a value of -1001 (a <q>random</q> number so
as to not conflict with <code>errno</code>) to indicate that a requested change is beyond a
device&rsquo;s capabilities.</p>

<p>The bindings check for these error codes, and in case one other than
<code>RATBAG_SUCCESS</code> is returned it will raise the appropriate exception:</p>

<pre><code class="language-python">class RatbagErrorCode(IntEnum):
    RATBAG_SUCCESS = 0

    &quot;&quot;&quot;An error occured on the device. Either the device is not a libratbag
    device or communication with the device failed.&quot;&quot;&quot;
    RATBAG_ERROR_DEVICE = -1000

    &quot;&quot;&quot;Insufficient capabilities. This error occurs when a requested change is
    beyond the device's capabilities.&quot;&quot;&quot;
    RATBAG_ERROR_CAPABILITY = -1001

    &quot;&quot;&quot;Invalid value or value range. The provided value or value range is
    outside of the legal or supported range.&quot;&quot;&quot;
    RATBAG_ERROR_VALUE = -1002

    &quot;&quot;&quot;A low-level system error has occured, e.g. a failure to access files
    that should be there. This error is usually unrecoverable and libratbag will
    print a log message with details about the error.&quot;&quot;&quot;
    RATBAG_ERROR_SYSTEM = -1003

    &quot;&quot;&quot;Implementation bug, either in libratbag or in the caller. This error is
    usually unrecoverable and libratbag will print a log message with details
    about the error.&quot;&quot;&quot;
    RATBAG_ERROR_IMPLEMENTATION = -1004


&quot;&quot;&quot;A table mapping RatbagErrorCode values to RatbagError* exceptions.&quot;&quot;&quot;
EXCEPTION_TABLE = {
    RatbagErrorCode.RATBAG_ERROR_DEVICE: RatbagErrorDevice,
    RatbagErrorCode.RATBAG_ERROR_CAPABILITY: RatbagErrorCapability,
    RatbagErrorCode.RATBAG_ERROR_VALUE: RatbagErrorValue,
    RatbagErrorCode.RATBAG_ERROR_SYSTEM: RatbagErrorSystem,
    RatbagErrorCode.RATBAG_ERROR_IMPLEMENTATION: RatbagErrorImplementation
}

def _dbus_call(self, method, type, *value):
    # Calls a method synchronously on the bus, using the given method name,
    # type signature and values.
    #
    # It the result is valid, it is returned. Invalid results raise the
    # appropriate RatbagError* or RatbagdDBus* exception, or GLib.Error if
    # it is an unexpected exception that probably shouldn't be passed up to
    # the UI.
    val = GLib.Variant(&quot;({})&quot;.format(type), value)
    try:
        res = self._proxy.call_sync(method, val,
                                    Gio.DBusCallFlags.NO_AUTO_START,
                                    2000, None)
        if res in EXCEPTION_TABLE:
            raise EXCEPTION_TABLE[res]
        return res.unpack()[0]  # Result is always a tuple
    except GLib.Error as e:
        if e.code == Gio.IOErrorEnum.TIMED_OUT:
            raise RatbagdDBusTimeout(e.message)
        else:
            # Unrecognized error code; print the message to stderr and raise
            # the GLib.Error.
            print(e.message, file=sys.stderr)
            raise
</code></pre>

<p>There&rsquo;s nothing wrong with this approach and it does in fact work fine. The
problem occurs when the <code>_dbus_call</code> method is used within a <code>GObject.Property</code>
setter method, because the <code>GObject.Property</code> decorator <a href="https://stackoverflow.com/questions/19639089/no-exceptions-from-gobject-properties-in-pygobject">doesn&rsquo;t raise
exceptions</a>.</p>

<p>This means that the exceptions raised from <code>_dbus_call</code> have to be caught within
these setter methods and cannot be left up to the clients to resolve. The only
way out of this then would be to return values from the setters, but then we
might as well directly return the libratbag error codes instead of raising
exceptions. Not only is that the wrong approach, it would also require <strong>all</strong>
usage of <em>any</em> setter method to check for return codes. Even if we wanted this,
the <code>GObject.Property</code> decorator doesn&rsquo;t allow you to return any values, either.
An alternative would be to set a sensible value upon error, or simply do nothing
at all. As you can see, neither solution is, well, a solution.</p>

<p>The only sane alternative is to do away with using <code>_dbus_call</code> from within
setter methods. After a quick inspection, there were only four such methods (<a href="https://github.com/libratbag/libratbag/issues/243">one
of which will be removed in due
time</a>), all of which were
using <code>_dbus_call</code> to set a read-only DBus property. There is no reason
whatsoever that these properties should be read-only with a setter method (in
fact, we actively refactored the DBus interface to remove such inconsistencies),
so <a href="https://github.com/libratbag/libratbag/pull/290">I made these properties read-write and removed the explicit
setters</a>. After this it was
simply a matter <a href="https://github.com/libratbag/piper/pull/148">updating the bindings
accordingly</a>, and voilà, issue
solved. Oh, and <a href="https://github.com/libratbag/piper/pull/145">the bindings&rsquo; setter methods also don&rsquo;t return values
anymore</a>, as this never worked in
the first place because the <code>GObject.Property</code> always returns the set value.</p>

<h3 id="macro-rework">Macro rework</h3>

<p>Last week I mentioned an issue with <a href="https://github.com/libratbag/piper/issues/141">correctly restoring the macro preview label
upon cancel</a>. There was another
issue that I forgot to mention: <a href="https://github.com/libratbag/piper/issues/100">the macro was displayed using its integer
keycodes</a>. For the latter issue,
we could easily copy the <code>KeyStroke::_update_macro</code> method to <code>ButtonsPage</code>, but
that results in unnecessary duplication. To solve this, I initially moved the
<code>_update_macro</code> method to be a new property on <code>RatbagdButton</code> instead:</p>

<pre><code class="language-python">@GObject.Property
def macro_str(self):
    &quot;&quot;&quot;A string representation of the current macro.&quot;&quot;&quot;
    keys = []
    for (type, val) in self.macro:
        if type == RatbagdButton.MACRO_KEY_PRESS:
            keys.append(&quot;↓{}&quot;.format(ecodes.KEY[val]))
        elif type == RatbagdButton.MACRO_KEY_RELEASE:
            keys.append(&quot;↑{}&quot;.format(ecodes.KEY[val]))
        elif type == RatbagdButton.MACRO_WAIT:
            keys.append(&quot;{:.2f}s&quot;.format(val / 1000.0))
    return &quot; &quot;.join(keys)
</code></pre>

<p>My mentor then rightfully pointed out that using a <code>*_str</code> method (in Python, at
least) is an indication that you should be using a proper class instead. This
was the catalyst to a large refactoring, where I removed the <code>KeyStroke</code> class
and introduced a <code>RatbagdMacro</code> class in the bindings instead. This class&rsquo;
responsibility is to abstract macros instead of the <code>KeyStroke</code> class, that
never really had a good place in the architecture to begin with: it abstracted
macros, but was also responsible for processing key events (and thus has
knowledge of both evdev and Gdk keycodes) and its lifetime was tied to that of a
button mapping dialog.</p>

<p>Intead, we now have a <code>RatbagdMacro</code> to abstract over macros, needing to know
only evdev keycodes. It uses <code>__str__</code> to give a string representation of the
macro it represents, and is not tied to the lifetime of the button dialog nor
does it process key events. Processing key events is now done entirely in
<code>ButtonDialog</code>, which is now responsible for mapping Gdk keycodes to their evdev
counterparts (see <a href="/blog/gsoc-part-9">part 9</a>), checking key validity and
instantiating a new <code>RatbagdMacro</code> for every capture-phase, correctly restoring
the macro preview labels upon cancel. I&rsquo;m sure that all of this is much better
explained by <a href="https://github.com/libratbag/piper/pull/136/commits/38e6843084d4bc58e921d3a877e9e9fbe9b675fd">the actual
diff</a>.</p>

<p>After this refactoring, actually displaying the macros in the buttons stack page
was <a href="https://github.com/libratbag/piper/pull/136/commits/6dd64f661e2f51ae41d12e08ff76a18f5b708490"><em>extremely</em>
straightforward</a>.
I also removed the checking for modifiers for Enter and Escape, as for example
pressing Enter with NumLock wouldn&rsquo;t accept a macro. Finally, you can now press
the Apply button directly from capturing a macro in order to apply it.</p>

<p>An issue with the way that macros were printed in Piper could lead to the
following, obviously unwanted, situation:</p>

<p><img src="/img/blog/gsoc-part-14/long_macro.png" alt="A long macro extending the UI" /></p>

<p>We therefore automatically break the line after 30 characters, resulting in a
much better behavior:</p>

<p><img src="/img/blog/gsoc-part-14/long_macro_fixed.png" alt="A long macro no longer extending the UI" /></p>

<p>We made the same change for the preview label inside the button mapping dialog&rsquo;s
list and the buttons displayed in the configuration stack pages. We also removed
the <code>KEY_</code> prefix in front of every key, and we use <code>↓</code>, <code>↑</code> and <code>↕</code> to denote a
key press, a key release and a key press immediately followed by an identical
key release, respectively.</p>

<p>With these changes, the programming part of my Summer of Code is now over. In
the next few days I&rsquo;ll publish a final blog post that will form my final
submission, and with that I&rsquo;ll officially finish Google Summer of Code. Until
then!</p>

<p>This blog post is part of a <a href="/series/gsoc/">series</a>. You can read the last part about the code
submission <a href="/blog/gsoc-part-15">here</a> or the previous part about saving the
planet <a href="/blog/gsoc-part-13">here</a>.</p>


                <br>
            </div>
            
            
                <div class="navigation">
                    
                    <div>
                        <img class="icon" src="/img/back.svg" alt="back" />
                        <a href="https://hjdskes.nl/blog/gsoc-part-13/">GSoC part 13: I solved global warming!</a>
                    </div>
                    
                    <div style="width: 100%;"></div>
                    
                    <div>
                        <a href="https://hjdskes.nl/blog/gsoc-part-15/">GSoC part 15: submission</a>
                        <img class="icon" src="/img/next.svg" alt="next" />
                    </div>
                    
                </div>
            
            <br>
            <div class="disqus">
                
            </div>
            
        </div>
    </div>
</div>

<div class="footer column">
    <div class="container">

        

        <div class="copyright">

        
            
                <a href="https://hjdskes.nl/license">Copyright © 2016-2018 Jente Hidskes</a>
            
        

        </div>
        <div class="icons">

        

        
            <a href="https://github.com/Hjdskes" target="_blank">
                <img class="icon" src="https://hjdskes.nl/img/github.svg" alt="github" />
            </a>
        

        

        

        
            <a href="mailto:hjdskes@gmail.com">
                <img class="icon" src="https://hjdskes.nl/img/email.svg" alt="email" />
            </a>
        

        
            <a href="https://hjdskes.nl/index.xml">
                <img class="icon" src="https://hjdskes.nl/img/rss.svg" alt="rss" />
            </a>
        

        </div>
    </div>
</div>




  <script src="https://hjdskes.nl/js/highlight.min.js" defer></script>
  











<script>
  window.onload = function() {
    
      hljs.initHighlighting();
    
    
    
  };
</script>




</body>
</html>

