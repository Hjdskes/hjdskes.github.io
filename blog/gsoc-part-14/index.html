<!DOCTYPE html>
<head>
  <meta charset="utf-8"/>
  <meta name="author" content="Jente Hidskes"/>
  <meta name="description" content="GSoC blog series on rewriting Piper"/>
  <meta name="generator" content="Hugo 0.46" />
  <meta name="referrer" content="no-referrer"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <meta property="og:description" content="GSoC blog series on rewriting Piper"/>
  <meta property="og:locale" content="en-us"/>
  <meta property="og:site_name" content="Jente Hidskes&#39; website"/>
  <meta property="og:title" content="GSoC part 14: final code changes"/>
  <meta property="og:type" content="article"/>
  <meta property="og:url" content="https://hjdskes.nl/blog/gsoc-part-14/"/>
  <meta property="og:image" content="https://hjdskes.nl/img/avatar.png"/>

  <title> Jente Hidskes&#39; website - GSoC part 14: final code changes </title>

  <link rel="canonical" href="https://hjdskes.nl/blog/gsoc-part-14/"/>
  
  <link rel="shortcut icon" href="https://hjdskes.nl/img/favicon.ico"/>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito|Quicksand|Roboto+Mono"/>
  <link rel="stylesheet" type="text/css" href="/css/stylesheet.css"/>
</head>

<body>
  <div class="banner">
    <a href="https://hjdskes.nl/"><img class="logo" src="https://hjdskes.nl/img/avatar.png" alt="logo" /></a>
    <div>
      <a id="name" href="https://hjdskes.nl/"><h1>Jente Hidskes&#39; website</h1></a>
      <nav>
        
        <a href="/blog/">Blog</a>
        
        
          
            
          
        
          
            
              <a href="https://hjdskes.nl/contributions">Contributions</a>
            
          
        
          
            
              <a href="https://hjdskes.nl/projects">Projects</a>
            
          
        
        
          
            <a href="https://hjdskes.nl/about/">About me</a>
          
        
          
        
      </nav>
    </div>
  </div>


<div class="page-heading">
  <h1>GSoC part 14: final code changes</h1>
</div>

<div class="meta">Aug 23, 2017<div class="middot">7 minute read</div>
  <div class="tags">
    <ul>
      
        <li class="middot"><a href="/tags/piper">Piper</a></li>
      
        <li class="middot"><a href="/tags/fdo">fdo</a></li>
      
        <li class="middot"><a href="/tags/macro">macro</a></li>
      
        <li class="middot"><a href="/tags/localization">localization</a></li>
      
        <li class="middot"><a href="/tags/property">property</a></li>
      
        <li class="middot"><a href="/tags/exception">exception</a></li>
      
    </ul>
  </div>
</div>

<div class="content">
  

<p><img src="/img/blog/gsoc-part-1/GSoC-logo-horizontal.svg" alt="GSoC logo horizontal" /></p>

<p>Well, this really is the last week of my Summer of Code! This will be a short
update on the final changes made since my <a href="/blog/gsoc-part-13">last update</a> on
Friday, which will be followed by a proper blog post for my final submission
later this week.</p>

<p>Last week I mentioned a few items that were
<a href="/blog/gsoc-part-13#work-in-progress">work-in-progress</a>. The search field for
the button mapping dialog has been merged, including its revamp of the dialog&rsquo;s
UI. The resolutions stack page now highlights the active resolution within the
list, and, most importantly, Piper can now be translated completely into your
native language! Here&rsquo;s Piper fully translated in Dutch:</p>

<video controls>
  <source src="/img/blog/gsoc-part-14/dutch.webm" type="video/webm">
Your browser does not support the video tag.
</video>

<p>I also reported on the work that was still to be done, which we&rsquo;ll get to now.</p>

<h3 id="piper-shouldn-t-crash-when-libratbag-returns-an-error">Piper shouldn&rsquo;t crash when libratbag returns an error</h3>

<p>Libratbag returns error codes to clients over DBus, it can for example return
<code>RATBAG_ERROR_CAPABILITY</code> that has a value of -1001 (a <q>random</q> number so
as to not conflict with <code>errno</code>) to indicate that a requested change is beyond a
device&rsquo;s capabilities.</p>

<p>The bindings check for these error codes, and in case one other than
<code>RATBAG_SUCCESS</code> is returned it will raise the appropriate exception:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">RatbagErrorCode</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="n">RATBAG_SUCCESS</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="s2">&#34;&#34;&#34;An error occured on the device. Either the device is not a libratbag
</span><span class="s2">    device or communication with the device failed.&#34;&#34;&#34;</span>
    <span class="n">RATBAG_ERROR_DEVICE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span>

    <span class="s2">&#34;&#34;&#34;Insufficient capabilities. This error occurs when a requested change is
</span><span class="s2">    beyond the device&#39;s capabilities.&#34;&#34;&#34;</span>
    <span class="n">RATBAG_ERROR_CAPABILITY</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1001</span>

    <span class="s2">&#34;&#34;&#34;Invalid value or value range. The provided value or value range is
</span><span class="s2">    outside of the legal or supported range.&#34;&#34;&#34;</span>
    <span class="n">RATBAG_ERROR_VALUE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1002</span>

    <span class="s2">&#34;&#34;&#34;A low-level system error has occured, e.g. a failure to access files
</span><span class="s2">    that should be there. This error is usually unrecoverable and libratbag will
</span><span class="s2">    print a log message with details about the error.&#34;&#34;&#34;</span>
    <span class="n">RATBAG_ERROR_SYSTEM</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1003</span>

    <span class="s2">&#34;&#34;&#34;Implementation bug, either in libratbag or in the caller. This error is
</span><span class="s2">    usually unrecoverable and libratbag will print a log message with details
</span><span class="s2">    about the error.&#34;&#34;&#34;</span>
    <span class="n">RATBAG_ERROR_IMPLEMENTATION</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1004</span>


<span class="s2">&#34;&#34;&#34;A table mapping RatbagErrorCode values to RatbagError* exceptions.&#34;&#34;&#34;</span>
<span class="n">EXCEPTION_TABLE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">RatbagErrorCode</span><span class="o">.</span><span class="n">RATBAG_ERROR_DEVICE</span><span class="p">:</span> <span class="n">RatbagErrorDevice</span><span class="p">,</span>
    <span class="n">RatbagErrorCode</span><span class="o">.</span><span class="n">RATBAG_ERROR_CAPABILITY</span><span class="p">:</span> <span class="n">RatbagErrorCapability</span><span class="p">,</span>
    <span class="n">RatbagErrorCode</span><span class="o">.</span><span class="n">RATBAG_ERROR_VALUE</span><span class="p">:</span> <span class="n">RatbagErrorValue</span><span class="p">,</span>
    <span class="n">RatbagErrorCode</span><span class="o">.</span><span class="n">RATBAG_ERROR_SYSTEM</span><span class="p">:</span> <span class="n">RatbagErrorSystem</span><span class="p">,</span>
    <span class="n">RatbagErrorCode</span><span class="o">.</span><span class="n">RATBAG_ERROR_IMPLEMENTATION</span><span class="p">:</span> <span class="n">RatbagErrorImplementation</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">_dbus_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">):</span>
    <span class="c1"># Calls a method synchronously on the bus, using the given method name,</span>
    <span class="c1"># type signature and values.</span>
    <span class="c1">#</span>
    <span class="c1"># It the result is valid, it is returned. Invalid results raise the</span>
    <span class="c1"># appropriate RatbagError* or RatbagdDBus* exception, or GLib.Error if</span>
    <span class="c1"># it is an unexpected exception that probably shouldn&#39;t be passed up to</span>
    <span class="c1"># the UI.</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">GLib</span><span class="o">.</span><span class="n">Variant</span><span class="p">(</span><span class="s2">&#34;({})&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxy</span><span class="o">.</span><span class="n">call_sync</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
                                    <span class="n">Gio</span><span class="o">.</span><span class="n">DBusCallFlags</span><span class="o">.</span><span class="n">NO_AUTO_START</span><span class="p">,</span>
                                    <span class="mi">2000</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">EXCEPTION_TABLE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EXCEPTION_TABLE</span><span class="p">[</span><span class="n">res</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">unpack</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Result is always a tuple</span>
    <span class="k">except</span> <span class="n">GLib</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">Gio</span><span class="o">.</span><span class="n">IOErrorEnum</span><span class="o">.</span><span class="n">TIMED_OUT</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RatbagdDBusTimeout</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Unrecognized error code; print the message to stderr and raise</span>
            <span class="c1"># the GLib.Error.</span>
            <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">raise</span></code></pre></div>
<p>There&rsquo;s nothing wrong with this approach and it does in fact work fine. The
problem occurs when the <code>_dbus_call</code> method is used within a <code>GObject.Property</code>
setter method, because the <code>GObject.Property</code> decorator <a href="https://stackoverflow.com/questions/19639089/no-exceptions-from-gobject-properties-in-pygobject">doesn&rsquo;t raise
exceptions</a>.</p>

<p>This means that the exceptions raised from <code>_dbus_call</code> have to be caught within
these setter methods and cannot be left up to the clients to resolve. The only
way out of this then would be to return values from the setters, but then we
might as well directly return the libratbag error codes instead of raising
exceptions. Not only is that the wrong approach, it would also require <strong>all</strong>
usage of <em>any</em> setter method to check for return codes. Even if we wanted this,
the <code>GObject.Property</code> decorator doesn&rsquo;t allow you to return any values, either.
An alternative would be to set a sensible value upon error, or simply do nothing
at all. As you can see, neither solution is, well, a solution.</p>

<p>The only sane alternative is to do away with using <code>_dbus_call</code> from within
setter methods. After a quick inspection, there were only four such methods (<a href="https://github.com/libratbag/libratbag/issues/243">one
of which will be removed in due
time</a>), all of which were
using <code>_dbus_call</code> to set a read-only DBus property. There is no reason
whatsoever that these properties should be read-only with a setter method (in
fact, we actively refactored the DBus interface to remove such inconsistencies),
so <a href="https://github.com/libratbag/libratbag/pull/290">I made these properties read-write and removed the explicit
setters</a>. After this it was
simply a matter <a href="https://github.com/libratbag/piper/pull/148">updating the bindings
accordingly</a>, and voilà, issue
solved. Oh, and <a href="https://github.com/libratbag/piper/pull/145">the bindings&rsquo; setter methods also don&rsquo;t return values
anymore</a>, as this never worked in
the first place because the <code>GObject.Property</code> always returns the set value.</p>

<h3 id="macro-rework">Macro rework</h3>

<p>Last week I mentioned an issue with <a href="https://github.com/libratbag/piper/issues/141">correctly restoring the macro preview label
upon cancel</a>. There was another
issue that I forgot to mention: <a href="https://github.com/libratbag/piper/issues/100">the macro was displayed using its integer
keycodes</a>. For the latter issue,
we could easily copy the <code>KeyStroke::_update_macro</code> method to <code>ButtonsPage</code>, but
that results in unnecessary duplication. To solve this, I initially moved the
<code>_update_macro</code> method to be a new property on <code>RatbagdButton</code> instead:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@GObject.Property</span>
<span class="k">def</span> <span class="nf">macro_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;A string representation of the current macro.&#34;&#34;&#34;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">RatbagdButton</span><span class="o">.</span><span class="n">MACRO_KEY_PRESS</span><span class="p">:</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;↓{}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ecodes</span><span class="o">.</span><span class="n">KEY</span><span class="p">[</span><span class="n">val</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">RatbagdButton</span><span class="o">.</span><span class="n">MACRO_KEY_RELEASE</span><span class="p">:</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;↑{}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ecodes</span><span class="o">.</span><span class="n">KEY</span><span class="p">[</span><span class="n">val</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">RatbagdButton</span><span class="o">.</span><span class="n">MACRO_WAIT</span><span class="p">:</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;{:.2f}s&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span></code></pre></div>
<p>My mentor then rightfully pointed out that using a <code>*_str</code> method (in Python, at
least) is an indication that you should be using a proper class instead. This
was the catalyst to a large refactoring, where I removed the <code>KeyStroke</code> class
and introduced a <code>RatbagdMacro</code> class in the bindings instead. This class&rsquo;
responsibility is to abstract macros instead of the <code>KeyStroke</code> class, that
never really had a good place in the architecture to begin with: it abstracted
macros, but was also responsible for processing key events (and thus has
knowledge of both evdev and Gdk keycodes) and its lifetime was tied to that of a
button mapping dialog.</p>

<p>Intead, we now have a <code>RatbagdMacro</code> to abstract over macros, needing to know
only evdev keycodes. It uses <code>__str__</code> to give a string representation of the
macro it represents, and is not tied to the lifetime of the button dialog nor
does it process key events. Processing key events is now done entirely in
<code>ButtonDialog</code>, which is now responsible for mapping Gdk keycodes to their evdev
counterparts (see <a href="/blog/gsoc-part-9">part 9</a>), checking key validity and
instantiating a new <code>RatbagdMacro</code> for every capture-phase, correctly restoring
the macro preview labels upon cancel. I&rsquo;m sure that all of this is much better
explained by <a href="https://github.com/libratbag/piper/pull/136/commits/38e6843084d4bc58e921d3a877e9e9fbe9b675fd">the actual
diff</a>.</p>

<p>After this refactoring, actually displaying the macros in the buttons stack page
was <a href="https://github.com/libratbag/piper/pull/136/commits/6dd64f661e2f51ae41d12e08ff76a18f5b708490"><em>extremely</em>
straightforward</a>.
I also removed the checking for modifiers for Enter and Escape, as for example
pressing Enter with NumLock wouldn&rsquo;t accept a macro. Finally, you can now press
the Apply button directly from capturing a macro in order to apply it.</p>

<p>An issue with the way that macros were printed in Piper could lead to the
following, obviously unwanted, situation:</p>

<p><img src="/img/blog/gsoc-part-14/long_macro.png" alt="A long macro extending the UI" /></p>

<p>We therefore automatically break the line after 30 characters, resulting in a
much better behavior:</p>

<p><img src="/img/blog/gsoc-part-14/long_macro_fixed.png" alt="A long macro no longer extending the UI" /></p>

<p>We made the same change for the preview label inside the button mapping dialog&rsquo;s
list and the buttons displayed in the configuration stack pages. We also removed
the <code>KEY_</code> prefix in front of every key, and we use <code>↓</code>, <code>↑</code> and <code>↕</code> to denote a
key press, a key release and a key press immediately followed by an identical
key release, respectively.</p>

<p>With these changes, the programming part of my Summer of Code is now over. In
the next few days I&rsquo;ll publish a final blog post that will form my final
submission, and with that I&rsquo;ll officially finish Google Summer of Code. Until
then!</p>

<p>This blog post is part of a <a href="/series/google-summer-of-code/">series</a>. You can read the last part about the code
submission <a href="/blog/gsoc-part-15">here</a> or the previous part about saving the
planet <a href="/blog/gsoc-part-13">here</a>.</p>

</div>

<div id="postamble">
  <footer>
    <nav class="social-icons">
       
        <a href="mailto:hjdskes@gmail.com" title="Send a mail to hjdskes@gmail.com">
          <svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
            <polyline points="22,6 12,13 2,6"/>
          </svg>
        </a>
      

       
        <a href="https://github.com/Hjdskes" title="Hjdskes on GitHub">
          <svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true">
            <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
	  </svg>
        </a>
      

       
        <a href="https://hjdskes.nl/index.xml" title="RSS feed">
          <svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true">
            <path d="M4 11a9 9 0 0 1 9 9"/>
	    <path d="M4 4a16 16 0 0 1 16 16"/>
	    <circle cx="5" cy="19" r="1"/>
	  </svg>
        </a>
      
    </nav>

    <div id="license-note">
      <a href="/license">Copyright © 2016-2018 Jente Hidskes</a>
    </div>
  </footer>
</div>

<link rel="stylesheet" type="text/css" href="/css/syntax.css"/>
<link rel="stylesheet" type="text/css" href="/css/zoom.css"/>
<script defer type="text/javascript" src="/js/zoom-vanilla.js"></script>
<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', function() {
    images = document.querySelectorAll("img[data-action=\"zoom\"]");
    images.forEach(function(image) {
      image.style.display = "block";
    })
  }, false);
</script>

</body>
</html>

